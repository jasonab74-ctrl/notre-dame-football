<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notre Dame Football — News & Feeds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{version}}">
</head>
<body>
  <header class="banner">
    <div class="brand">
      <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/9/9a/ND_logo_monogram.svg" alt="ND" />
      <div class="titles">
        <h1>Notre Dame</h1>
        <h1>Football</h1>
        <div class="updated">Updated: {{ last_updated_iso }}</div>
      </div>
    </div>
    <button id="fightBtn" class="pill pill--cta" type="button" aria-pressed="false">Victory March</button>
    <audio id="fightSong" preload="auto">
      <source src="https://upload.wikimedia.org/wikipedia/commons/5/57/Victory_March.ogg" type="audio/ogg">
    </audio>
  </header>

  <main class="container">
    <section id="linksRow" class="links-row"></section>

    <div class="filters">
      <label for="sourceSelect" class="label">News sources:</label>
      <div class="select-wrap">
        <select id="sourceSelect">
          <option value="__all__">All sources</option>
        </select>
      </div>
      <button id="refreshBtn" class="pill pill--ghost" type="button">refresh</button>
    </div>

    <section id="feed" class="feed">
      {% for it in initial_items %}
      <article class="card" data-src="{{ it.get('source','').strip() }}">
        <a class="card__title" target="_blank" rel="noopener" href="{{ it.get('url','#') }}">{{ it.get('title','') }}</a>
        {% if it.get('summary') %}
        <p class="card__summary">{{ it.get('summary') }}</p>
        {% endif %}
        <div class="card__meta">
          <span class="card__chip">{{ it.get('source','') }}</span>
          <span class="dot">•</span>
          <time>{{ it.get('published','') }}</time>
        </div>
      </article>
      {% endfor %}
    </section>
  </main>

  <script>
    // -------------------
    // Fight Song (no jump)
    // -------------------
    const fightBtn = document.getElementById('fightBtn');
    const audio = document.getElementById('fightSong');
    fightBtn.addEventListener('click', () => {
      const playing = !audio.paused && !audio.ended;
      if (playing) { audio.pause(); fightBtn.classList.remove('playing'); fightBtn.textContent = 'Victory March'; }
      else { try { audio.currentTime = 0; audio.play(); } catch(_) {} fightBtn.classList.add('playing'); fightBtn.textContent = '⏸ Victory March'; }
    });

    // -------------------
    // Data hydration
    // -------------------
    const feedEl = document.getElementById('feed');
    const sourceSel = document.getElementById('sourceSelect');
    const linksRow = document.getElementById('linksRow');
    const refreshBtn = document.getElementById('refreshBtn');

    function renderItems(items) {
      const src = sourceSel.value;
      const rows = (src === '__all__') ? items : items.filter(x => (x.source||'') === src);
      feedEl.innerHTML = rows.map(it => `
        <article class="card" data-src="${(it.source||'').trim()}">
          <a class="card__title" target="_blank" rel="noopener" href="${it.url || '#'}">${it.title || ''}</a>
          ${it.summary ? `<p class="card__summary">${it.summary}</p>` : ``}
          <div class="card__meta">
            <span class="card__chip">${it.source || ''}</span><span class="dot">•</span>
            <time>${it.published || ''}</time>
          </div>
        </article>
      `).join('');
    }

    async function loadFeedsMeta() {
      try {
        const meta = await (await fetch('/feeds.json',{cache:'no-store'})).json();
        // Links row
        const links = meta.links || [];
        linksRow.innerHTML = links.map(l => `<a class="pill pill--link" target="_blank" rel="noopener" href="${l.href}">${l.label}</a>`).join('');
        // Sources dropdown
        const feeds = meta.feeds || [];
        const opts = ['<option value="__all__">All sources</option>']
          .concat(feeds.map(f => `<option value="${f.name}">${f.name}</option>`));
        sourceSel.innerHTML = opts.join('');
      } catch (e) { console.warn('feeds.json load failed', e); }
    }

    async function loadItems() {
      try {
        const data = await (await fetch('/items.json',{cache:'no-store'})).json();
        renderItems(data.items || []);
      } catch (e) { console.warn('items.json load failed', e); }
    }

    sourceSel.addEventListener('change', loadItems);
    refreshBtn.addEventListener('click', loadItems);

    // Initial hydrate
    loadFeedsMeta().then(loadItems);
  </script>
</body>
</html>