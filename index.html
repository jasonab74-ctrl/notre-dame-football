<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notre Dame Football</title>
  <link rel="icon" href="static/favicon.ico">
  <link rel="apple-touch-icon" href="static/apple-touch-icon.png">
  <link rel="stylesheet" href="static/style.css">
  <meta name="theme-color" content="#0C2340">
</head>
<body>
  <header>
    <img src="static/notre-dame-logo.png" class="logo" alt="ND">
    <div class="titles">
      <div class="brand">Notre Dame Football</div>
      <div class="subtitle">Live news feed · auto-refreshing</div>
    </div>
    <div class="actions">
      <!-- Keep label constant to avoid button "jump"; style change only -->
      <button class="pill" id="songBtn" aria-pressed="false">Victory March</button>
    </div>
  </header>

  <nav class="links" id="quickLinks"></nav>

  <div id="updated">Updated: —</div>

  <div class="controls">
    <label for="srcSel">News sources:</label>
    <select id="srcSel"><option value="*">All sources</option></select>
  </div>

  <main class="grid" id="grid"></main>

  <footer>
    <div>Auto-checking for new items…</div>
    <a href="items.json">items.json</a>
  </footer>

  <audio id="song" preload="none" src="static/fight-song.mp3"></audio>

  <script>
    const els = {
      grid: document.getElementById('grid'),
      updated: document.getElementById('updated'),
      srcSel: document.getElementById('srcSel'),
      links: document.getElementById('quickLinks'),
      song: document.getElementById('song'),
      songBtn: document.getElementById('songBtn'),
    };

    // Header quick links (added Reddit ND Football back)
    const STATIC_LINKS = [
      {"label":"Inside ND Sports (Rivals)","url":"https://notredame.rivals.com/"},
      {"label":"247Sports ND","url":"https://247sports.com/college/notre-dame/"},
      {"label":"CBS ND","url":"https://www.cbssports.com/college-football/teams/ND/notre-dame-fighting-irish/"},
      {"label":"Reddit (Notre Dame Football)","url":"https://www.reddit.com/r/NotreDame/search?q=football&restrict_sr=on&sort=new"},
      {"label":"ND Insider","url":"https://www.southbendtribune.com/sports/notre-dame/"},
      {"label":"Fighting Irish Wire","url":"https://fightingirishwire.usatoday.com/"},
      {"label":"One Foot Down","url":"https://www.onefootdown.com/"},
      {"label":"Blue & Gold (On3)","url":"https://www.on3.com/teams/notre-dame-fighting-irish/"},
      {"label":"Schedule","url":"https://fightingirish.com/sports/football/schedule/"},
      {"label":"Roster","url":"https://fightingirish.com/sports/football/roster/"},
      {"label":"AP Poll","url":"https://apnews.com/hub/ap-top-25-college-football-poll"},
      {"label":"Coaches Poll","url":"https://www.usatoday.com/sports/ncaaf/polls/coaches-poll/"}
    ];

    function buildLinks(){
      els.links.innerHTML = STATIC_LINKS.map(l => `<a class="pill" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`).join('');
    }

    function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    function parseDate(item){
      if (typeof item.ts === 'number') return new Date(item.ts*1000);
      if (item.ts && !Number.isNaN(Number(item.ts))) return new Date(Number(item.ts)*1000);
      if (item.published_iso) return new Date(item.published_iso);
      return new Date();
    }
    function fmtDate(item){ return parseDate(item).toLocaleString(); }

    let all = {items:[]};

    function render(){
      const src = els.srcSel.value;
      const items = all.items.filter(i => src === '*' || i.source === src);
      els.grid.innerHTML = items.map(it => `
        <article class="card">
          <a class="title" href="${it.link}" target="_blank" rel="noopener">${escapeHtml(it.title)}</a>
          <div class="meta">${escapeHtml(it.source || 'Unknown')} • ${escapeHtml(fmtDate(it))}</div>
        </article>
      `).join('');
    }

    async function load(){
      const r = await fetch('items.json?cb='+Date.now());
      const j = await r.json();
      all = j;
      els.updated.textContent = 'Updated: ' + new Date().toLocaleString();

      // Build the dropdown from the real outlets we wrote into items.json
      const set = new Set(j.items.map(i => i.source).filter(Boolean));
      els.srcSel.innerHTML = '<option value="*">All sources</option>' +
        [...set].sort().map(s => `<option>${escapeHtml(s)}</option>`).join('');
      render();
    }

    // Auto-refresh every 5 minutes
    setInterval(load, 5*60*1000);

    // Keep button label constant; only toggle a CSS class (no layout jump)
    els.songBtn.addEventListener('click', () => {
      if (els.song.paused){ els.song.play(); els.songBtn.setAttribute('aria-pressed','true'); els.songBtn.classList.add('playing'); }
      else { els.song.pause(); els.songBtn.setAttribute('aria-pressed','false'); els.songBtn.classList.remove('playing'); }
    });

    buildLinks();
    load();
  </script>
</body>
</html>